WITH CTE AS ( SELECT CASE WHEN ONLINE_OR_IN_PERSON = 1 THEN 'Online' WHEN
ONLINE_OR_IN_PERSON = 2 THEN 'In Person' END AS TRANSACTION_TYPE,
QUARTER(DATE(transaction_date,'dd/MM/yyyy hh24:mi:ss')) as QUARTER, SUM(VALUE)
AS TOTAL_VALUE, FROM PD2023_WK01, WHERE SPLIT_PART (TRANSACTION_CODE,'-',1) =
'DSB' GROUP BY CASE WHEN ONLINE_OR_IN_PERSON = 1 THEN 'Online' WHEN
ONLINE_OR_IN_PERSON = 2 THEN 'In Person' END,
QUARTER(DATE(transaction_date,'dd/MM/yyyy hh24:mi:ss')) ) SELECT
ONLINE_OR_IN_PERSON, REPLACE(T.QUARTER, 'Q',''):: INT AS QUARTER, V.TOTAL_VALUE,
TARGET, V.TOTAL_VALUE- TARGET AS VARIANCE, FROM PD2023_WK03_TARGETS AS T
UNPIVOT(TARGET FOR QUARTER IN (Q1,Q2,Q3,Q4)) INNER JOIN CTE AS V ON
T.ONLINE_OR_IN_PERSON =V.TRANSACTION_TYPE AND REPLACE(T.QUARTER, 'Q',''):: INT =
V.QUARTER
