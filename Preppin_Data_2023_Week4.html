-- UNION ALL MONTHLY TABLES TOGETHER AND INCLUDE MONTH NUMBER COLUMN FOR EACH TABLE AND SAVE AS CTE

WITH CTE AS (
SELECT 1 AS MONTH, * FROM PD2023_WK04_JANUARY, 
UNION ALL 
SELECT 2
AS MONTH, * FROM PD2023_WK04_FEBRUARY, 
UNION ALL 
SELECT 3 AS MONTH, * FROM PD2023_WK04_MARCH, 
UNION ALL 
SELECT 4 AS MONTH, * FROM PD2023_WK04_APRIL, 
UNION ALL 
SELECT 5 AS MONTH, * FROM PD2023_WK04_MAY, 
UNION ALL 
SELECT 6 AS MONTH, * FROM PD2023_WK04_JUNE, 
UNION ALL 
SELECT 7 AS MONTH, * FROM PD2023_WK04_JULY,
UNION ALL 
SELECT 8 AS MONTH, * FROM PD2023_WK04_AUGUST, 
UNION ALL 
SELECT 9 AS MONTH, * FROM PD2023_WK04_SEPTEMBER, 
UNION ALL 
SELECT 10 AS MONTH, * FROM PD2023_WK04_OCTOBER, 
UNION ALL 
SELECT 11 AS MONTH, * FROM PD2023_WK04_NOVEMBER,
UNION ALL 
SELECT 12 AS MONTH, * FROM PD2023_WK04_DECEMBER, ), 

--CREATE A TABLE WITH THE DESIRED FIELDS TO USE AS THE BASE TABLE FOR THE PIVOT
PRE_PIVOT AS
(SELECT 
ID, 
DATE_FROM_PARTS(2023, MONTH,JOINING_DAY) AS JOIN_DATE, 
DEMOGRAPHIC,
VALUE, 
FROM CTE), 

-- PIVOTING THE PRE_PIVOT TABLE USING THE CONTENTS OF THE VALUE TABLE AND DEMOGRAPHICS AS THE HEADERS
-- ROW 47 BEING USED TO ISOLATE ANY DUPLICATE ROWS BY ASSIGNING DUPLICATES A NUMBER OF 2 
FINAL_TABLE AS ( 
SELECT 
ID, 
JOIN_DATE, 
Account_Type,
Ethnicity, 
Date_of_Birth :: DATE AS DATE_OF_BIRTH, 
ROW_NUMBER() OVER(PARTITION BY ID ORDER BY JOIN_DATE ASC) AS CHECK_DUPLICATES 
FROM PRE_PIVOT 
PIVOT
(MAX(VALUE) FOR DEMOGRAPHIC IN ('Date of Birth','Account Type', 'Ethnicity')) AS P 
(ID, 
JOIN_DATE, 
Date_of_Birth, 
Account_Type, 
Ethnicity) ) 

-- CREATE A FINAL TABLE WITH THE DESIRED COLUMNS AND FILTER OUT ANY DUPLICTAES BY FILTERING THE CHECKER TO 1 
SELECT ID,
JOIN_DATE, ACCOUNT_TYPE, ETHNICITY, DATE_OF_BIRTH, 
FROM FINAL_TABLE 
WHERE CHECK_DUPLICATES = 1
