WITH CTE AS ( SELECT 1 AS MONTH, * FROM PD2023_WK04_JANUARY, UNION ALL SELECT 2
AS MONTH, * FROM PD2023_WK04_FEBRUARY, UNION ALL SELECT 3 AS MONTH, * FROM
PD2023_WK04_MARCH, UNION ALL SELECT 4 AS MONTH, * FROM PD2023_WK04_APRIL, UNION
ALL SELECT 5 AS MONTH, * FROM PD2023_WK04_MAY, UNION ALL SELECT 6 AS MONTH, *
FROM PD2023_WK04_JUNE, UNION ALL SELECT 7 AS MONTH, * FROM PD2023_WK04_JULY,
UNION ALL SELECT 8 AS MONTH, * FROM PD2023_WK04_AUGUST, UNION ALL SELECT 9 AS
MONTH, * FROM PD2023_WK04_SEPTEMBER, UNION ALL SELECT 10 AS MONTH, * FROM
PD2023_WK04_OCTOBER, UNION ALL SELECT 11 AS MONTH, * FROM PD2023_WK04_NOVEMBER,
UNION ALL SELECT 12 AS MONTH, * FROM PD2023_WK04_DECEMBER, ), PRE_PIVOT AS
(SELECT ID, DATE_FROM_PARTS(2023, MONTH,JOINING_DAY) AS JOIN_DATE, DEMOGRAPHIC,
VALUE, FROM CTE), FINAL_TABLE AS ( SELECT ID, JOIN_DATE, Account_Type,
Ethnicity, Date_of_Birth :: DATE AS DATE_OF_BIRTH, ROW_NUMBER() OVER(PARTITION
BY ID ORDER BY JOIN_DATE ASC) AS CHECK_DUPLICATES FROM PRE_PIVOT PIVOT
(MAX(VALUE) FOR DEMOGRAPHIC IN ('Date of Birth','Account Type', 'Ethnicity')) AS
P (ID, JOIN_DATE, Date_of_Birth, Account_Type, Ethnicity) ) SELECT ID,
JOIN_DATE, ACCOUNT_TYPE, ETHNICITY, DATE_OF_BIRTH, FROM FINAL_TABLE WHERE
CHECK_DUPLICATES = 1
